<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<!--
    SQL File Name : lgu_v1_message_sql.xml
    Description : 메시지 발송 데이터 관리
    author 451773
    since 2024. 01. 19.
    version 1.0
    Modification Information
        since        author            description
    ===========    =============    ===========================
    2024.01.19        451773         최초 생성
-->

<mapper namespace="com.bwc.message.v1.sender.dao.lgu.v1.LguV1MessageDAO">

    <!--
        Query ID : insertSendSmsMessage
        Description : 메시지 발송 요청 [SMS]
    -->
    <insert id="insertSendSmsMessage" parameterType="com.bwc.message.v1.gate.dto.MessageGateSendReqDTO">
        /*com.bwc.message.v1.sender.dao.lgu.v1.LguV1MessageDAO.insertSendSmsMessage*/
        INSERT INTO SC_TRAN (TR_SENDDATE,
                             TR_SENDSTAT,
                             TR_MSGTYPE,
                             TR_PHONE,
                             TR_CALLBACK,
                             TR_MSG,
                             TR_ETC1,
                             TR_ETC2,
                             TR_ETC3,
                             TR_ETC4)
        VALUES ( GETDATE()
               , '0'
               , '0'
               , #{receiverPhone}
               , #{senderNumber}
               , #{sendMsg}
               , '71'
               , #{sendUid} -- 호출시스템 관리용 KEY
               , #{sessGuid}
               , #{serviceCode})
    </insert>

    <!--
        Query ID : insertSendMmsMessage
        Description : 메시지 발송 요청 [MMS]
    -->
    <insert id="insertSendMmsMessage" parameterType="com.bwc.message.v1.gate.dto.MessageGateSendReqDTO">
        /*com.bwc.message.v1.sender.dao.lgu.v1.LguV1MessageDAO.insertSendMmsMessage*/
        INSERT INTO MMS_MSG ( SUBJECT
                            , PHONE
                            , CALLBACK
                            , STATUS
                            , REQDATE
                            , MSG
                            , TYPE
                            , ETC1
                            , ETC2
                            , ETC3
                            , ETC4
                            , FILE_CNT
                            , FILE_PATH1
                            , FILE_PATH2
                            , FILE_PATH3
                            , FILE_PATH4)
        VALUES ( NULLIF(#{subject}, '제목없음')
               , #{receiverPhone}
               , #{senderNumber}
               , '0'
               , GETDATE()
               , #{sendMsg}
               , '0'
               , '71'
               , #{sendUid} -- 호출시스템 관리용 KEY
               , #{sessGuid}
               , CAST(#{serviceCode} AS INT)
               , ''
               , ''
               , ''
               , ''
               , '')
    </insert>

    <!--
    Query ID : selectSmsMessageStatus
    Description : 메시지 발송 상태 조회
    파라미터 선언에서 $ type을 사용한 이유 : 로그테이블이 월별로 생성되어 table명이 동적이다.
    이 때문에 sqlInjection 취약점으로 나타날순 있으나, 앞서 table name을 처리하는 과정이 VO에서 캡슐화되어 있고,
    유효한 테이블 명만 반환 하는 형태로 되어 있음.
 -->
    <select id="selectSmsMessageStatus" resultType="com.bwc.message.v1.sender.vo.MessageStatusVO"
            parameterType="com.bwc.message.v1.sender.vo.MessageStatusVO">
        /*com.bwc.message.v1.sender.dao.lgu.v1.LguV1MessageDAO.selectSmsMessageStatus*/
        select STATUS,
               #{serviceCode} AS SERVICE_CODE,
               #{sendUid}     AS SEND_UID,
               #{sessGuid}    AS SESS_GUID,
               #{sendDate}    AS SEND_DATE,
               #{sendType}    AS SEND_TYPE,
               #{vender}      AS VENDER
        From (select TR_SENDSTAT AS STATUS
              from SC_TRAN AS A
              where TR_ETC2 = #{sendUid}
                AND TR_ETC3 = #{sessGuid}
                AND TR_ETC4 = #{serviceCode}
                and FORMAT(TR_SENDDATE, 'yyyyMMdd') = #{sendDate}

              UNION ALL
              select TR_SENDSTAT AS STATUS
              from ${table} AS A
              where TR_ETC2 = #{sendUid}
                AND TR_ETC3 = #{sessGuid}
                AND TR_ETC4 = #{serviceCode}
                and FORMAT(TR_SENDDATE, 'yyyyMMdd') = #{sendDate}) A
    </select>
    <!--
    Query ID : selectMmsMessageStatus
    Description : 메시지 발송 상태 조회
    파라미터 선언에서 $ type을 사용한 이유 : 로그테이블이 월별로 생성되어 table명이 동적이다.
    이 때문에 sqlInjection 취약점으로 나타날순 있으나, 앞서 table name을 처리하는 과정이 VO에서 캡슐화되어 있고,
    유효한 테이블 명만 반환 하는 형태로 되어 있음.
 -->
    <select id="selectMmsMessageStatus" resultType="com.bwc.message.v1.sender.vo.MessageStatusVO"
            parameterType="com.bwc.message.v1.sender.vo.MessageStatusVO">
        /*com.bwc.message.v1.sender.dao.lgu.v1.LguV1MessageDAO.selectMmsMessageStatus*/
        SELECT STATUS,
               #{serviceCode} AS SERVICE_CODE,
               #{sendUid}     AS SEND_UID,
               #{sessGuid}    AS SESS_GUID,
               #{sendDate}    AS SEND_DATE,
               #{sendType}    AS SEND_TYPE,
               #{vender}      AS VENDER
        FROM (select STATUS AS STATUS
              from MMS_MSG AS A
              where ETC2 = #{sendUid}
                AND ETC3 = #{sessGuid}
                AND ETC4 = CAST(#{serviceCode} AS INT)
                and FORMAT(SENTDATE, 'yyyyMMdd') = #{sendDate}

              UNION ALL
              select STATUS AS STATUS
              from ${table} AS A
              where ETC2 = #{sendUid}
                AND ETC3 = #{sessGuid}
                AND ETC4 = CAST(#{serviceCode} AS INT)
                and FORMAT(SENTDATE, 'yyyyMMdd') = #{sendDate}) A
    </select>


</mapper>